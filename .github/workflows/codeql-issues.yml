name: Create Issues from CodeQL Alerts

on:
  workflow_run:
    workflows: ["CodeQL"]
    types:
      - completed

jobs:
  create_issues:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      security-events: read

    steps:
      - name: Process CodeQL Alerts and Create Issues
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Ëé∑ÂèñÊâÄÊúâÊú™Ëß£ÂÜ≥ÁöÑ CodeQL Alert
            const alerts = await github.rest.codeScanning.listAlertsForRepo({
              owner,
              repo,
              state: "open"
            });

            for (const alert of alerts.data) {
              const rule = alert.rule;

              const title = `[CodeQL] ${rule.id}: ${rule.description}`;

              // ÈÅøÂÖçÈáçÂ§ç Issue
              const existingIssues = await github.rest.search.issuesAndPullRequests({
                q: `repo:${owner}/${repo} "${title}" in:title state:open`
              });

              if (existingIssues.data.total_count > 0) {
                console.log(`Issue already exists: ${title}`);
                continue;
              }

              const instance = alert.most_recent_instance;

              const body = [
                '### üö® CodeQL Alert Summary',
                '',
                '**Rule:** ' + rule.id,
                '**Severity:** ' + rule.severity,
                '**Description:** ' + rule.description,
                '',
                '---',
                '',
                '### üìç Location',
                '- **File:** ' + instance.location.path,
                '- **Line:** ' + instance.location.startLine,
                '',
                '---',
                '',
                '### üßæ Full Description',
                (rule.fullDescription || '(No additional details)'),
                '',
                '---',
                '',
                '_This issue was automatically generated from CodeQL alerts._'
              ].join('\n');

              // ÂàõÂª∫ Issue Âπ∂Ëá™Âä®Âä†Ê†áÁ≠æ codeql
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: ["codeql"]
              });

              console.log(`Created issue: ${title}`);
            }
